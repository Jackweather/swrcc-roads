<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NY Highway Cameras</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  /* Reset and base styles */
  * { box-sizing: border-box; }
  body, html {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #e9ecef;
    height: 100%; display: flex; flex-direction: column;
  }

  /* Header */
  header {
    background-color: #343a40;
    color: #fff;
    padding: 12px 20px;
    text-align: center;
    font-size: 1.6rem;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  /* Back button */
  #backBtn {
    display: inline-block;
    margin: 12px auto;
    padding: 10px 20px;
    font-size: 16px;
    background-color: #343a40;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #backBtn:hover { background-color: #0056b3; }

  /* Video grid */
  #videoGrid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    grid-auto-rows: 180px;
    gap: 12px;
    padding: 12px;
    overflow-y: auto;
  }

  #videoGrid video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
    background-color: #000;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    transition: transform 0.3s ease;
    cursor: pointer;
  }
  #videoGrid video:hover { transform: scale(1.05); }

  /* Message styling */
  #videoGrid p {
    grid-column: 1/-1;
    text-align: center;
    color: #555;
    font-size: 1.1rem;
    margin-top: 40px;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) { #videoGrid { grid-auto-rows: 150px; gap: 8px; } }
  @media (max-width: 480px) {
    #videoGrid { grid-auto-rows: 120px; gap: 6px; }
    header { font-size: 1.3rem; }
    #backBtn { padding: 8px 16px; font-size: 14px; }
  }
</style>
</head>
<body>

<header>NY Roadway Cameras</header>
<button id="backBtn" onclick="window.location.href='/'">Back to Map</button>
<div id="videoGrid"></div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.0/dist/hls.min.js"></script>
<script>
const grid = document.getElementById('videoGrid');
let cameras = [];
let startIndex = 0;
const videosOnScreen = 28;

// Fetch cameras from Flask API
fetch("/api/cameras")
  .then(res => res.json())
  .then(data => {
    // Keep the video URL and lat/lon
    cameras = data.filter(c => c.VideoUrl && c.Latitude && c.Longitude)
                  .map(c => ({
                    url: c.VideoUrl,
                    lat: c.Latitude,
                    lon: c.Longitude,
                    name: c.Name || "Camera"
                  }));
    if(cameras.length === 0){
      grid.innerHTML = "<p>No cameras available.</p>";
      return;
    }
    showCameras();
    setInterval(showCameras, 10000); // rotate every 10 seconds
  })
  .catch(err => {
    console.error(err);
    grid.innerHTML = "<p>Error fetching cameras.</p>";
  });

// Show current batch of cameras
function showCameras() {
  grid.innerHTML = '';
  for (let i = 0; i < videosOnScreen; i++) {
    if(cameras.length === 0) break;

    const cameraIndex = (startIndex + i) % cameras.length;
    const camera = cameras[cameraIndex];
    const vid = document.createElement('video');
    vid.autoplay = true;
    vid.controls = true;
    vid.muted = true;

    // Click goes to Google Maps at lat/lon
    vid.onclick = () => {
      const url = `https://www.google.com/maps?q=${camera.lat},${camera.lon}`;
      window.open(url, "_blank");
    }

    if(Hls.isSupported()){
      const hls = new Hls();
      hls.loadSource(camera.url);
      hls.attachMedia(vid);
    } else {
      vid.src = camera.url;
    }

    grid.appendChild(vid);
  }

  startIndex = (startIndex + videosOnScreen) % cameras.length;
}
</script>

</body>
</html>
